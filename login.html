<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="" />
    <meta name="author" content="" />

    <title>Flight Reservation Login</title>
    <link href="./assets/css/bootstrap.min.css" rel="stylesheet" />
    <link
      href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
      rel="stylesheet"
    />
    <link
      href="//cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css"
      rel="stylesheet"
    />
    <link href="./assets/css/startmin.css" rel="stylesheet" />
    <link
      href="./assets/css/font-awesome.min.css"
      rel="stylesheet"
      type="text/css"
    />
  </head>

  <body style="display: none">
    <div class="container">
      <div id="login-form" class="row">
        <div class="col-md-4 col-md-offset-4">
          <div class="login-panel panel panel-default">
            <div class="panel-heading">
              <h3 class="panel-title">Please Sign In</h3>
            </div>
            <div class="panel-body">
              <form id="login-form-form" role="form">
                <fieldset>
                  <div class="form-group">
                    <input
                      id="email"
                      class="form-control"
                      placeholder="E-mail"
                      name="email"
                      type="email"
                      autofocus
                    />
                  </div>
                  <div class="form-group">
                    <input
                      id="password"
                      class="form-control"
                      placeholder="Password"
                      name="password"
                      type="password"
                      value=""
                    />
                  </div>
                  <div class="form-group">
                    <button
                      id="loginbutton"
                      onclick="loginUser();"
                      class="btn btn-lg btn-success btn-block"
                    >
                      Login
                    </button>
                  </div>
                  <div class="form-group pull-left">
                    <a onclick="showForgotForm()" href="#">
                      Forgot your password?
                    </a>
                  </div>
                  <div class="form-group pull-right">
                    <a onclick="showRegistrationForm()" href="#">
                      Don't have an account? Sign up now!
                    </a>
                  </div>
                </fieldset>
              </form>
            </div>
          </div>
        </div>
      </div>
      <div id="form-alert" class="row hidden">
        <div class="alert alert-success" role="alert"></div>
      </div>
      <div id="register-form" class="row hidden">
        <div class="col-md-4 col-md-offset-4">
          <div class="login-panel panel panel-default">
            <div class="panel-heading">
              <h3 class="panel-title">Create new account</h3>
            </div>
            <div class="panel-body">
              <form id="register-form-form" role="form">
                <fieldset>
                  <div class="form-group">
                    <input
                      id="register-username"
                      class="form-control"
                      placeholder="Username"
                      name="username"
                      type="text"
                    />
                  </div>
                  <div class="form-group">
                    <input
                      id="register-email"
                      class="form-control"
                      placeholder="E-mail"
                      name="email"
                      type="email"
                    />
                  </div>
                  <div class="form-group">
                    <input
                      id="register-password"
                      class="form-control"
                      placeholder="Password"
                      name="password"
                      type="password"
                      value=""
                    />
                  </div>
                  <div class="form-group">
                    <button
                      id="registerbutton"
                      onclick="registerUser()"
                      class="btn btn-lg btn-success btn-block"
                    >
                      Register
                    </button>
                  </div>
                  <div class="form-group pull-right">
                    <a onclick="showLoginForm()" href="#"
                      >Already have an account? Sign in!</a
                    >
                  </div>
                </fieldset>
              </form>
            </div>
          </div>
        </div>
      </div>
      <div id="forgot-form" class="row hidden">
        <div class="col-md-4 col-md-offset-4">
          <div class="login-panel panel panel-default">
            <div class="panel-heading">
              <h3 class="panel-title">Forgot Password</h3>
            </div>
            <div class="panel-body">
              <form id="forgot-form-form" role="form">
                <fieldset>
                  <div class="form-group">
                    <input
                      id="forgot-email"
                      class="form-control"
                      placeholder="E-mail"
                      name="email"
                      type="email"
                      autofocus
                    />
                  </div>
                  <div class="form-group">
                    <button
                      id="forgotbutton"
                      onclick="sendToken();"
                      class="btn btn-lg btn-success btn-block"
                    >
                      Send recovery token
                    </button>
                  </div>
                  <div class="form-group pull-right">
                    <a onclick="showLoginForm()" href="#">
                      Back to Login screen
                    </a>
                  </div>
                </fieldset>
              </form>
            </div>
          </div>
        </div>
      </div>
      <div id="reset-password-form" class="row hidden">
        <div class="col-md-4 col-md-offset-4">
          <div class="login-panel panel panel-default">
            <div class="panel-heading">
              <h3 class="panel-title">Reset Password</h3>
            </div>
            <div class="panel-body">
              <form id="reset-form-form" role="form">
                <fieldset>
                  <div class="form-group">
                    <input
                      id="reset-password-token"
                      name="token"
                      type="hidden"
                    />
                  </div>
                  <div class="form-group">
                    <input
                      id="reset-password"
                      class="form-control"
                      placeholder="Password"
                      name="password"
                      type="password"
                      value=""
                    />
                  </div>
                  <div class="form-group">
                    <button
                      id="resetButton"
                      onclick="resetPassword();"
                      class="btn btn-lg btn-success btn-block"
                    >
                      Reset password
                    </button>
                  </div>
                  <div class="form-group pull-right">
                    <a onclick="showLoginForm()" href="#"> Back to Login </a>
                  </div>
                </fieldset>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script src="./assets/js/jquery.min.js"></script>
    <script src="./assets/js/utilities.js"></script>
    <script src="./assets/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script type="text/javascript">
      $(function () {
        if (localStorage.getItem("token")) {
          window.location = "index.html";
        } else $("body").show();

        var urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has("token")) {
          $("#reset-password-token").val(urlParams.get("token"));
          showChangePassword();
        }
      });

      function showChangePassword() {
        $("#reset-password-form").removeClass("hidden");
        $("#login-form").addClass("hidden");
        $("#register-form").addClass("hidden");
        $("#forgot-form").addClass("hidden");
      }

      function changePassword() {
            var change_info = {
                "token": $('#reset-password-token').val(),
                "password": $('#reset-password').val()
            }
            $('#resetButton').prop('disabled', true);
            $.post("api/reset", JSONIZE_form('#reset-form-form'))
                .done(function (data) {
                    window.localStorage.setItem("token", data.token);
                    window.location = "index.html";
                }).fail(function (error) {
                    $('#resetButton').prop('disabled', false);
                    alert(error.responseJSON.message);
                });
        }

      function showForgotForm() {
        $("#login-form").addClass("hidden");
        $("#forgot-form").removeClass("hidden");
      }

      function showRegistrationForm() {
        $("#login-form").addClass("hidden");
        $("#register-form").removeClass("hidden");
      }

      function showLoginForm() {
        $("#login-form").removeClass("hidden");
        $("#register-form").addClass("hidden");
        $("#forgot-form").addClass("hidden");
      }

      function sendToken() {
            $('#forgotbutton').prop('disabled', true);
            $.post("api/forgot", Utilities.JSONIZE_form('#forgot-form-form'))
                .done(function (data) {
                    console.log(data);
                    $('#forgot-form').addClass('hidden');
                    $('#form-alert').removeClass('hidden');
                    $('#form-alert .alert').html(data.message);
                }).fail(function (error) {
                    $('#forgotbutton').prop('disabled', false);
                    $('#forgot-form').addClass('hidden');
                    $('#form-alert').removeClass('hidden');
                    $('#form-alert .alert').html(error.responseJSON.message);
                });

        };

      function registerUser() {
            $('#registerbutton').prop('disabled', true);
            $.post("api/register", Utilities.JSONIZE_form('#register-form-form'))
                .done(function (data) {
                    $('#register-form').addClass("hidden");
                    $('#form-alert').removeClass("hidden");
                    $('#form-alert .alert').html(data.message);
                }).fail(function (error) {
                    $('#registerbutton').prop('disabled', false);
                    alert(error.responseJSON.message);
                });

        };

      function loginUser() {
            $('#loginbutton').prop('disabled', true);
            $.post("api/login", Utilities.JSONIZE_form('#login-form-form'))
                .done(function (data) {
                    window.localStorage.setItem("token", data.token);
                    var user_info = Utilities.parse_jwt(window.localStorage.getItem("token"));
                    if (user_info.role == "ADMIN") {
                        window.location = "index.html";
                        toastr.success("Logged in!");
                    }
                    else {
                        window.location = "index2.html";
                        toastr.success("Logged in!");
                    }

                }).fail(function (error) {
                    $('#loginbutton').prop('disabled', false);
                    toastr.error(error.responseJSON.message);
                });

        }
    </script>
  </body>
</html>
